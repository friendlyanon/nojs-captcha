// ==UserScript==
// @name           nojs-captcha
// @version        0.0.1
// @namespace      friendlyanon
// @description    NoJS Captcha everywhere
// @license        WTFPL
// @include        https://*
// @include        http://*
// @grant          none
// @run-at         document-start
// ==/UserScript==

/* This program is free software. It comes without any warranty, to the extent
 * permitted by applicable law. You can redistribute it and/or modify it under
 * the terms of the Do What The Fuck You Want To Public License, Version 2, as
 * published by Sam Hocevar. See http://www.wtfpl.net/ for more details. */

"use strict";

const d = self.document;
const $ = (s, r = d) => r.querySelector(s);
const $$ = (s, r = d) => r.querySelectorAll(s);
const on = (t, ...a) => t.addEventListener(...a);
const off = (t, ...a) => t.removeEventListener(...a);
const messageId = "ti0ksfcuvum";
!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){r.r(t);const n=e=>{for(;;){const t=e.parentNode;switch(t){case d:return!0;case null:return!1}e=t}},{assign:i,defineProperty:o,prototype:{hasOwnProperty:s}}=Object,a=(e,t)=>s.call(e,t);function l(e,t,r=null){return null==e?r:e[t]}const c=new WeakMap;let u;const f=()=>{u&&(u=u.remove())},p=e=>{f(),(e=>{if(null!=u)return;d.body.insertAdjacentHTML("beforeend",'<iframe role="presentation" scrolling="no" style="width: 302px; height: 423px; position: fixed; top: 0; left: calc(50% - 151px); z-index: 9999;" src="https://www.google.com/recaptcha/api/fallback?k=" frameborder="0"></iframe>'),u=d.body.lastElementChild,c.set(u,{id:e});const{parameters:t}=g.get(e),r=a(t,"theme")&&"dark"===t.theme?"&theme=dark":"";u.src+=t.sitekey+r})(e)},h=e=>{p(e)},b=e=>{f()},m=new Map,g=new Map,y=(e=>{let t=!1;return()=>{t||(t=!0,e())}})(()=>{self.setInterval(()=>{for(const{0:e,1:t}of m)n(e)||(g.delete(t.id),m.delete(e),b(t.id))},1e3)}),v=(e=>()=>e++)(0),x=e=>void 0!==e?(e=>g.get(e))(e):(()=>g.values().next().value)();class w{constructor(e,t){this._target=e,this.parameters=t,this.id=v(),m.set(e,this),g.set(this.id,this),e.innerHTML='<div style="width: 304px; height: 78px;"><div><iframe src="about:blank" width="304" height="78" role="presentation" frameborder="0" scrolling="no" style="display: block !important;"></iframe></div><textarea name="g-recaptcha-response" style="display: none;"></textarea></div>',this._text=$("textarea",e),this._iframe=$("iframe",e),self.setTimeout(()=>this._initIframe(),100)}get invisible(){const e=this.parameters;return a(e,"size")&&"invisible"===e.size}get response(){return this._text.value}set response(e){this._text.value=e;const t=$("button",this._iframe.contentDocument);if(e){if(b(this.id),t.className="completed",a(this.parameters,"callback"))try{const{callback:t}=this.parameters;"function"==typeof t?t(e):(0,self[t])(e)}catch(e){}}else t.removeAttribute("class")}execute(){p(this.id)}reset(){this.response="",h(this.id)}_initIframe(){const e=this._iframe.contentDocument;e.head.innerHTML='<meta charset="utf8" /><style>* { margin: 0; padding: 0; border: 0; } button:not(.completed):before { content: "Verify Captcha"; } button.completed:before { content: "Captcha verified"; }</style>',e.body.innerHTML='<div style="width: 304px; height: 78px; display: grid;"><button></button></div>',on($("button",e),"click",e=>this._clickHandler(e))}_clickHandler(e){e.preventDefault(),e.target.hasAttribute("class")?this.reset():this.execute()}}const k=()=>{self.location.href.endsWith("theme=dark")&&(e=>{const{head:t}=d;t.insertAdjacentHTML("beforeend",'<style type="text/css"></style>'),t.lastElementChild.appendChild(new Text(e))})("body {   color: rgb(197, 200, 198); } div.fbc {   border: 1px solid black;   border-radius: 0;   background-color: #282a2e; } .fbc-button-reload, .fbc-button-audio {   filter: invert(1); } .fbc-payload-imageselect {   position: relative; } fbc-imageselect-payload {   position: relative;   z-index: 1; } .fbc-payload-imageselect > input {   z-index: 3; } .fbc-payload-imageselect > label {   position: absolute;   display: block;   height: 93px;   width: 93px;   z-index: 2; }")},T=/\{([^}]+)\}/gu,_=()=>{const e=$(".fbc-verification-token");null!=e?(e=>{const t=[messageId,e.firstElementChild.value];parent.postMessage(t,"*")})(e):(()=>{const e=$(".fbc-payload-imageselect");if(e){e.style.position="relative";for(let t=0;t<9;){const r={column:t/3|0,row:t%3|0},n=`fbc-imageselect-checkbox-${++t}`,i="top: {column}px; left: {row}px; width: 93px; height: 93px; position: absolute;".replace(T,(e,t)=>String(93*r[t])),o=$("."+n,e);o.setAttribute("id",n),o.insertAdjacentHTML("beforebegin",`<label for="${n}" style="${i}"></label>`)}}else{const e=$("body > .fbc");e&&5===e.children.length&&e.children[2].insertAdjacentText("beforeend"," Is your ad blocker set up correctly?")}})()},M=e=>{const t=e,r=t.data;if(!Array.isArray(r)||r[0]!==messageId)return;const n=(e=>{for(const t of $$("iframe"))if(t.contentWindow===e)return t})(t.source);g.get(c.get(n).id).response=r[1]},j={render(e,t={},r=!0){const n="string"==typeof e?d.getElementById(e):e;if(null==n)throw new Error("reCAPTCHA placeholder element must be an element or id");return r&&(t=i({},n.dataset,t)),new w((e=>{switch(e.tagName){case"BUTTON":return!0;case"INPUT":break;default:return!1}switch(e.type){case"submit":case"button":return!0}return!1})(n)?(e=>e.parentNode.insertBefore(d.createElement("div"),e))(n):n,t).id},execute(e){const t=x(e);null!=t&&t.invisible&&t.execute()},reset(e){const t=x(e);null!=t&&t.reset()},getResponse(e){const t=x(e);if(null!=t)return t.response;throw new Error("Invalid reCAPTCHA client id: "+e)},ready:e=>("function"!=typeof e&&(e=(e=>()=>e.handleEvent())(e)),self.setTimeout(e,0))},A=(e,t=d)=>{switch(String(t.readyState).toLowerCase()){case"interactive":case"complete":return void self.setTimeout(e,0)}on(t,"DOMContentLoaded",e,{once:!0})},C=()=>{const e=$("script[src*='/recaptcha/api.js']");if(null==e)return;y(),on(self,"message",M);const{search:t}=new URL(e.getAttribute("src")),r=l(t.match(/render=([^&?]+)/i),1,"onload"),n=l(t.match(/onload=([^&?]+)/i),1);if("onload"===r){const e=$("div.g-recaptcha");null!=e&&j.render(e)}null!=n&&(0,self[n])()};if(/^(?:https?:)?\/\/(?:www\.)?google\.com\/recaptcha\/api\/fallback/iu.test(self.location.href))k(),A(_);else{A(C);const e=e=>e,t=Object.entries(j).reduce((t,{0:r,1:n})=>(o(t,r,{set:e,get:()=>n,enumerable:!0}),t),{});o(self,"grecaptcha",{set:e,get:()=>t,enumerable:!0})}}]);